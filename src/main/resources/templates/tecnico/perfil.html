<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security" lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Mi perfil - Técnico</title>
  <link th:href="@{/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
  <link th:href="@{/iconos/bootstrap-icons.css}" rel="stylesheet">
  <link th:href="@{/tema/miestilo.css}" rel="stylesheet">
</head>
<body>
<header th:replace="~{page-templates :: navbar}"></header>

<main class="container my-4">
  <div class="shadow-lg p-4 bg-body-tertiary rounded">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">Mi perfil</h2>
      <a class="btn btn-outline-secondary" th:href="@{/tecnico}"><i class="bi bi-arrow-left"></i> Panel</a>
    </div>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">Datos del técnico</h5>
            <dl class="row mb-0">
              <dt class="col-sm-4">Nombre</dt>
              <dd class="col-sm-8" th:text="${tecnico != null ? tecnico.nombre : 'N/D'}">N/D</dd>
              <dt class="col-sm-4">Correo</dt>
              <dd class="col-sm-8" th:text="${tecnico != null ? tecnico.correo : 'N/D'}">correo</dd>
              <dt class="col-sm-4">Teléfono</dt>
              <dd class="col-sm-8" th:text="${tecnico != null ? tecnico.telefono : 'N/D'}">tel</dd>
              <dt class="col-sm-4">Dirección</dt>
              <dd class="col-sm-8" th:text="${tecnico != null ? tecnico.direccion : 'N/D'}">dir</dd>
              <dt class="col-sm-4">Estado</dt>
              <dd class="col-sm-8">
                <span class="badge" th:classappend="${tecnico != null && tecnico.estado.name() == 'DISPONIBLE'} ? ' bg-success' : ' bg-secondary'"
                      th:text="${tecnico != null ? tecnico.estado : 'N/A'}">DISPONIBLE</span>
                <span class="badge ms-2" th:classappend="${tecnico != null && tecnico.disponibleAhora} ? ' bg-primary' : ' bg-secondary'"
                      th:text="${tecnico != null && tecnico.disponibleAhora ? 'Aceptando urgencias' : 'Sin urgencias'}"></span>
              </dd>
              <dt class="col-sm-4">Notas</dt>
              <dd class="col-sm-8" th:text="${tecnico != null && tecnico.notasDisponibilidad != null ? tecnico.notasDisponibilidad : 'Sin notas'}"></dd>
            </dl>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">Documentos</h5>
            <p class="mb-1">Certificación:</p>
            <div><a th:if="${tecnico != null}" class="btn btn-sm btn-outline-primary" th:href="${tecnico.rutaCertificacion}" target="_blank"><i class="bi bi-file-earmark-text me-1"></i>Ver certificación</a>
                 <span th:if="${tecnico == null}" class="text-muted">N/D</span></div>
            <hr/>
            <p class="mb-1">E-firma:</p>
            <div><a th:if="${tecnico != null}" class="btn btn-sm btn-outline-primary" th:href="${tecnico.rutaEfirma}" target="_blank"><i class="bi bi-file-earmark-text me-1"></i>Ver e-firma</a>
                 <span th:if="${tecnico == null}" class="text-muted">N/D</span></div>
            <hr/>
            <h5 class="card-title mt-3">Foto de perfil</h5>
            <div class="mb-2">
              <img th:if="${tecnico != null && tecnico.rutaFotoPerfil != null}" th:src="@{/tecnico/foto}" alt="Foto perfil" class="img-thumbnail" style="max-height: 160px;">
              <div th:if="${tecnico == null || tecnico.rutaFotoPerfil == null}" class="text-muted">Sin foto</div>
            </div>
            <form th:action="@{/tecnico/foto}" method="post" enctype="multipart/form-data">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
              <div class="input-group">
                <input type="file" class="form-control" name="foto" accept="image/*" required>
                <button class="btn btn-primary" type="submit"><i class="bi bi-upload"></i> Subir</button>
              </div>
              <small class="text-muted">Se guardará como id_timestamp.ext</small>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <h5>Disponibilidad registrada</h5>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
          <tr>
            <th>Día</th>
            <th>Horario</th>
            <th>Estado</th>
          </tr>
          </thead>
          <tbody>
          <tr th:if="${#lists.isEmpty(disponibilidades)}">
            <td colspan="3" class="text-muted text-center">Configura tus horarios desde la sección de solicitudes.</td>
          </tr>
          <tr th:each="disp : ${disponibilidades}">
            <td th:text="${#strings.capitalize(disp.dia.name().toLowerCase())}"></td>
            <td>
              <span th:text="${disp.horaInicio}"></span>
              <span> - </span>
              <span th:text="${disp.horaFin}"></span>
            </td>
            <td>
              <span class="badge" th:classappend="${disp.activo} ? ' bg-success' : ' bg-secondary'"
                    th:text="${disp.activo ? 'Activo' : 'Inactivo'}"></span>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<footer th:replace="~{page-templates :: footer}"></footer>
<script th:src="@{/bootstrap/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
