name: Deploy Servitec

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'Dockerfile'
      - 'pom.xml'
      - '.github/workflows/deploy-servitec.yml'
  workflow_dispatch:

env:
  IMAGE_NAME: us-central1-docker.pkg.dev/servitec-476518/servitec-app/servitec:latest
  CONTAINER_NAME: servitec_app
  VM_PORT_MAPPING: 127.0.0.1:8090:8090
  DOCKER_NETWORK: servitec_network
  DB_CONTAINER_NAME: servitec_db
  DB_VOLUME_NAME: servitec_db_data
  MARIADB_IMAGE: mariadb:10.11

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: servitec-476518

      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build Docker image
        run: docker build -t "$IMAGE_NAME" .

      - name: Push Docker image
        run: docker push "$IMAGE_NAME"

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: read
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: servitec-476518

      - name: Generate Artifact Registry access token
        id: gcp_token
        run: echo "token=$(gcloud auth print-access-token)" >> "$GITHUB_OUTPUT"

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.SERVITEC_SSH_KEY }}" > key.pem
          chmod 600 key.pem
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.SERVITEC_VM_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy on rodev
        env:
          ACCESS_TOKEN: ${{ steps.gcp_token.outputs.token }}
          DB_ROOT_PASSWORD: ${{ secrets.SERVITEC_DB_ROOT_PASSWORD }}
          DB_NAME: ${{ secrets.SERVITEC_DB_NAME }}
          DB_USER: ${{ secrets.SERVITEC_DB_USER }}
          DB_PASSWORD: ${{ secrets.SERVITEC_DB_PASSWORD }}
        run: |
          ssh -i key.pem "${{ secrets.SERVITEC_SSH_USER }}"@"${{ secrets.SERVITEC_VM_HOST }}" \
            'bash -s' \
            "$ACCESS_TOKEN" \
            "$IMAGE_NAME" \
            "$CONTAINER_NAME" \
            "$VM_PORT_MAPPING" \
            "$DOCKER_NETWORK" \
            "$DB_CONTAINER_NAME" \
            "$DB_VOLUME_NAME" \
            "$MARIADB_IMAGE" \
            "$DB_ROOT_PASSWORD" \
            "$DB_NAME" \
            "$DB_USER" \
            "$DB_PASSWORD" <<'EOF'
          ACCESS_TOKEN="${1:-}"
          image_name="${2:-us-central1-docker.pkg.dev/servitec-476518/servitec-app/servitec:latest}"
          container_name="${3:-servitec_app}"
          vm_port_mapping="${4:-127.0.0.1:8090:8090}"
          docker_network="${5:-servitec_network}"
          db_container_name="${6:-servitec_db}"
          db_volume_name="${7:-servitec_db_data}"
          mariadb_image="${8:-mariadb:10.11}"
          db_root_password="${9:-}"
          db_name="${10:-}"
          db_user="${11:-}"
          db_password="${12:-}"

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "[deploy] ERROR: ACCESS_TOKEN argument not provided."
            exit 1
          fi

          set -eo pipefail
          set -u

          if [ -z "$image_name" ]; then
            echo "[deploy] ERROR: IMAGE_NAME argument not provided."
            exit 1
          fi

          echo "[deploy] Authenticating against Artifact Registry"
          echo "$ACCESS_TOKEN" | sudo docker login --username oauth2accesstoken --password-stdin https://us-central1-docker.pkg.dev

          echo "[deploy] Current disk usage"
          df -h /
          sudo docker system df || true

          echo "[deploy] Stopping previous container (if any)"
          sudo docker stop "$container_name" || true
          sudo docker rm "$container_name" || true

          echo "[deploy] Pruning old artefacts"
          sudo docker image prune -af || true
          sudo docker system prune -af || true

          echo "[deploy] Ensuring Docker network $docker_network"
          if ! sudo docker network inspect "$docker_network" >/dev/null 2>&1; then
            sudo docker network create "$docker_network"
          fi

          echo "[deploy] Ensuring volume $db_volume_name"
          sudo docker volume create "$db_volume_name" >/dev/null

          if [ -z "$db_root_password" ] || [ -z "$db_name" ] || [ -z "$db_user" ] || [ -z "$db_password" ]; then
            echo "[deploy] ERROR: Database secrets are not defined. Aborting deployment."
            exit 1
          fi

          echo "[deploy] Deploying MariaDB container"
          sudo docker pull "$mariadb_image"
          sudo docker stop "$db_container_name" || true
          sudo docker rm "$db_container_name" || true
          sudo docker run -d --name "$db_container_name" --restart unless-stopped \
            --network "$docker_network" \
            -v "$db_volume_name":/var/lib/mysql \
            -e MYSQL_ROOT_PASSWORD="$db_root_password" \
            -e MYSQL_DATABASE="$db_name" \
            -e MYSQL_USER="$db_user" \
            -e MYSQL_PASSWORD="$db_password" \
            "$mariadb_image" \
            --lower_case_table_names=1 \
            --character-set-server=utf8mb4 \
            --collation-server=utf8mb4_unicode_ci

          echo "[deploy] Waiting for MariaDB to accept connections"
          for attempt in $(seq 1 30); do
            if sudo docker exec "$db_container_name" mysqladmin ping -h 127.0.0.1 -p"$db_root_password" --silent; then
              break
            fi
            sleep 2
            if [ "$attempt" -eq 30 ]; then
              echo "[deploy] ERROR: MariaDB did not become ready in time."
              exit 1
            fi
          done

          echo "[deploy] Pulling new image $image_name"
          sudo docker pull "$image_name"

          echo "[deploy] Running container"
          sudo docker run -d --name "$container_name" --restart unless-stopped \
            --network "$docker_network" \
            -p "$vm_port_mapping" \
            -e SPRING_PROFILES_ACTIVE=docker \
            -e SPRING_DATASOURCE_URL="jdbc:mariadb://$db_container_name:3306/$db_name" \
            -e SPRING_DATASOURCE_USERNAME="$db_user" \
            -e SPRING_DATASOURCE_PASSWORD="$db_password" \
            "$image_name"

          echo "[deploy] Container status"
          sudo docker ps --filter "name=$container_name"
          EOF








